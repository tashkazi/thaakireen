<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Thaakireen - Student List</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body {
      margin: 0;
      padding-bottom: 60px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f9f7;
    }
    header, footer {
      background-color: #387a5f;
      color: #fff;
      padding: 10px 20px;
      position: fixed;
      width: 100%;
      z-index: 1000;
    }
    header {
      top: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    footer {
      bottom: 0;
      text-align: center;
    }
    #logo img {
      max-height: 50px;
    }
    #menu-container ul {
      list-style: none;
      display: flex;
      gap: 20px;
      margin-right: 50px;
      padding: 0;
    }
    #menu-container a {
      text-decoration: none;
      color: #fff;
      font-weight: bold;
    }
    .container {
      max-width: 1100px;
      margin: 120px auto 40px;
      padding: 30px;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.07);
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 26px;
      color: #2e5e4e;
    }
    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
      justify-content: flex-start;
    }
    label {
      font-weight: 600;
    }
    select, input, button {
      padding: 8px 12px;
      font-size: 15px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    button {
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 14px;
      text-align: center;
      border: 1px solid #ddd;
    }
    th {
      background-color: #d0e7de;
      font-weight: bold;
    }
    td.name-cell {
      text-align: left;
    }
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    #savePdfBtn {
      margin-top: 20px;
      background-color: #387a5f;
      color: white;
      font-weight: bold;
      border: none;
      border-radius: 6px;
      padding: 10px 16px;
    }
  </style>
</head>
<body>
  <header>
    <div id="logo"><img src="uploads/Logo.png" alt="Thaakireen Logo"></div>
    <div id="menu-container">
      <ul>
        <li><a href="Homepage.html">Home</a></li>
        <li><a href="Profile.html">My Profile</a></li>
        <li><a href="Login.html">Logout</a></li>
      </ul>
    </div>
  </header>

 <main class="container">
  <h1>ðŸ“š Student List</h1>

  <div class="controls" id="controlsContainer"></div>

  <!-- Save PDF Button -->
  <button id="savePdfBtn">ðŸ’¾ Save Class as PDF</button>

  <!-- Student Table -->
  <table id="studentTable">
    <thead>
      <tr>
        <th>Name</th>
        <th>Gender</th>
        <th>School Grade</th>
        <th>Book Grade</th>
        <th>Assigned Teacher</th>
      </tr>
    </thead>
    <tbody id="studentList">
      <!-- Rows will be populated by JavaScript -->
    </tbody>
  </table>
</main>


  <footer>
    <p>&copy; 2024 Thaakireen. All rights reserved.</p>
  </footer>

  <script>
    let isAdmin = false;
    let currentTeacherId = null;
    let allStudents = [];
    let dropdownData = {};

    document.addEventListener("DOMContentLoaded", async () => {
      const res = await fetch("check_student_access.php");
      const userData = await res.json();
      isAdmin = userData.isAdmin;
      currentTeacherId = userData.teacherId;

      if (!userData.allowed) {
        document.body.innerHTML = '<h2 style="color:red;text-align:center;margin-top:100px">You do not have access to this page.</h2>';
        return;
      }

      dropdownData = await fetch("fetch_dropdowns.php").then(res => res.json());

      if (isAdmin) initAdminView();
      else initTeacherView();
    });

    function initAdminView() {
      const container = document.getElementById("controlsContainer");

      const teacherSelect = document.createElement("select");
      teacherSelect.id = "teacherFilter";
      teacherSelect.setAttribute("aria-label", "Teacher Filter");
      teacherSelect.innerHTML = `<option value="">-- Select Teacher --</option>` +
        dropdownData.teachers.map(t => `<option value="${t.id}">${t.title || ""} ${t.first_name} ${t.last_name}</option>`).join("");

      const viewTypeSelect = document.createElement("select");
      viewTypeSelect.id = "viewTypeSelect";
      viewTypeSelect.setAttribute("aria-label", "View Type");
      viewTypeSelect.innerHTML = `
        <option value="weekday">Weekday Class</option>
        <option value="friday">Friday Class</option>
      `;

      teacherSelect.onchange = adminFilter;
      viewTypeSelect.onchange = adminFilter;

      container.appendChild(teacherSelect);
      container.appendChild(viewTypeSelect);

      adminFilter(); // Initial load
    }

    function adminFilter() {
      const teacherId = document.getElementById("teacherFilter")?.value;
      const viewType = document.getElementById("viewTypeSelect")?.value;
      if (!teacherId) return displayStudentRows([]);

      loadStudents({ teacherId, friday: viewType === "friday" });
    }

    function initTeacherView() {
      const container = document.getElementById("controlsContainer");
      const weekdayBtn = createButton("ðŸ“… Weekday Class", () => loadStudents({ teacherId: currentTeacherId }));
      const fridayBtn = createButton("ðŸ“˜ Friday Class", () => loadStudents({ teacherId: currentTeacherId, friday: true }));
      container.appendChild(weekdayBtn);
      container.appendChild(fridayBtn);
      loadStudents({ teacherId: currentTeacherId });
    }

    function createButton(text, onClick) {
      const btn = document.createElement("button");
      btn.textContent = text;
      btn.style = "background-color: #387a5f; color: white; font-weight: bold; border: none; border-radius: 6px; padding: 8px 12px; cursor: pointer;";
      btn.onclick = onClick;
      return btn;
    }

    function loadStudents({ teacherId = "", friday = false } = {}) {
      const url = new URL("fetch_students.php", location.origin);
      if (teacherId) url.searchParams.set("teacher_id", teacherId);
      if (friday) url.searchParams.set("friday", 1);

      fetch(url)
        .then(res => res.json())
        .then(data => {
          allStudents = data;
          displayStudentRows(data);
        });
    }

    function displayStudentRows(data) {
      const tbody = document.getElementById("studentList");
      tbody.innerHTML = "";

      data.forEach(s => {
        const teacher = s.teacherName || s.fridayTeacherName || "";
        tbody.innerHTML += `
          <tr>
            <td class="name-cell">${s.firstName} ${s.lastName}</td>
            <td>${s.school_grade || ""}</td>
            <td>${s.book_grade || ""}</td>
            <td>${teacher}</td>
          </tr>`;
      });
    }

    document.getElementById("savePdfBtn").addEventListener("click", () => {
      if (allStudents.length === 0) {
        alert("No student data to export.");
        return;
      }

      const table = document.getElementById("studentTable").cloneNode(true);
      const today = new Date().toISOString().split("T")[0];
      const container = document.createElement("div");
      container.style.fontFamily = "Arial, sans-serif";
      container.style.padding = "20px";
      const heading = document.createElement("h2");
      heading.textContent = `ðŸ“š Saved Class List (${today})`;
      heading.style.textAlign = "center";
      container.appendChild(heading);
      table.style.borderCollapse = "collapse";
      table.querySelectorAll("th, td").forEach((cell, i) => {
        cell.style.border = "1px solid #aaa";
        cell.style.padding = "8px";
        cell.style.fontSize = "12px";
        cell.style.textAlign = i % 4 === 0 ? "left" : "center";
      });
      container.appendChild(table);
      html2pdf().set({
        margin: 0.4,
        filename: `Class_List_${today}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 1.5, scrollY: 0 },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
      }).from(container).save();
    });
  </script>
</body>
</html>
