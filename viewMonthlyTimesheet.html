<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monthly Time Sheet</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f9f7;
    }
    header, footer {
      background-color: #387a5f;
      color: #fff;
      padding: 10px 20px;
      position: fixed;
      width: 100%;
      z-index: 1000;
    }
    header { top: 0; display: flex; justify-content: space-between; align-items: center; }
    footer { bottom: 0; text-align: center; }
    #logo img { max-height: 50px; }
    #menu-container ul {
      list-style: none;
      display: flex;
      align-items: center;
      gap: 20px;
      margin-right: 50px;
      padding: 0;
    }
    #menu-container a {
      text-decoration: none;
      color: #fff;
      font-weight: bold;
    }
    .container {
      max-width: 1000px;
      margin: 120px auto 60px;
      padding: 20px;
    }
    h1 { text-align: center; color: #2e5e4e; }
    #userDisplayName { text-align: center; margin-top: -10px; font-weight: bold; font-size: 1.1em; color: #444; }
    table { width: 100%; border-collapse: collapse; background: #fff; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
    th { background-color: #d0e7de; }
    .actions { text-align: right; margin-top: 20px; }
    button { padding: 10px 15px; background-color: #387a5f; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background-color: #2f5d4e; }
    .total { text-align: right; font-weight: bold; margin-top: 10px; }
    .no-print { display: block; }
   


@media print {
    body * {
      visibility: hidden;
    }
    #pdfExportContent, #pdfExportContent * {
      visibility: visible;
    }
    #pdfExportContent {
      position: absolute;
      left: 0;
      top: 0;
    }
  }
  </style>
</head>
<body>

<header>
  <div id="logo">
    <img src="uploads/Logo.png" alt="Thaakireen Logo">
  </div>
  <div id="menu-container">
    <ul>
      <li><a href="Homepage.html">Home</a></li>
      <li><a href="Profile.html">My Profile</a></li>
      <li><a href="Login.html">Logout</a></li>
    </ul>
  </div>
</header>


<div id="pdfExportContent">
  <div class="container" id="pdfContent">
<h1 id="userHeader">ðŸ“… Monthly Time Sheet</h1>
<div id="monthOutput" style="text-align:center; font-weight:bold; font-size:1.2em; margin-top:5px; color:#2e5e4e;"></div>



    <div class="no-print">
      <label for="monthSelect">Select Month:</label>
      <input type="month" id="monthSelect" onchange="loadMonthlyTimesheet()" />
    </div>

    <table id="monthlyTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Day</th>
          <th>Start Time</th>
          <th>End Time</th>
          <th>Hours Worked</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="total">Total Hours: <span id="monthlyTotal">0</span></div>

    <div class="actions no-print">
     <button onclick="downloadTable()">Download PDF</button>

      <button onclick="location.href='teacherTimesheet.html'">â¬… Back to Weekly</button>
    </div>
  </div>
</div>


<footer>
  <p>&copy; 2024 Thaakireen. All rights reserved.</p>
</footer>
<script>
let currentUserName = "";

fetch("get_logged_in_user.php")
  .then(res => res.json())
  .then(data => {
    if (data.name) {
      currentUserName = data.name;
      document.getElementById("userDisplayName").textContent = ` for ${currentUserName}`;
    }
  });

function loadMonthlyTimesheet() {
  const month = document.getElementById("monthSelect").value;
  if (!month) return;

  // âœ… Use fixed lookup instead of Date() to avoid timezone issues
  const [year, monthNum] = month.split("-");
  const monthNames = [
    "January", "February", "March", "April", "May", "June",
    "July", "August", "September", "October", "November", "December"
  ];
  const monthName = monthNames[parseInt(monthNum, 10) - 1];

  // âœ… Update header text
  const fullText = `${currentUserName} â€” ${monthName} ${year}`;
  document.getElementById("monthOutput").textContent = fullText;

  fetch(`get_monthly_timesheet.php?month=${month}`)
    .then(res => res.json())
    .then(data => {
      const tbody = document.querySelector("#monthlyTable tbody");
      const totalEl = document.getElementById("monthlyTotal");
      tbody.innerHTML = "";
      let total = 0;

      if (data.success) {
        data.entries.forEach(e => {
          const row = document.createElement("tr");
          const status = e.is_absent == 1 ? "Absent" : "Present";
          row.innerHTML = `
            <td>${e.date}</td>
            <td>${e.day}</td>
            <td>${e.start_time || '-'}</td>
            <td>${e.end_time || '-'}</td>
            <td>${parseFloat(e.hours_worked).toFixed(2)}</td>
            <td>${status}</td>
          `;
          tbody.appendChild(row);
          total += parseFloat(e.hours_worked);
        });
      } else {
        const row = document.createElement("tr");
        row.innerHTML = `<td colspan="6">No records found.</td>`;
        tbody.appendChild(row);
      }
      totalEl.textContent = total.toFixed(2);
    });
}

function downloadTable() {
  const original = document.getElementById("pdfExportContent");
  const clone = original.cloneNode(true);

  // âœ… Remove dropdowns and buttons
  const elementsToRemove = clone.querySelectorAll(".no-print");
  elementsToRemove.forEach(el => el.remove());

  // âœ… Use clone for clean export
  const tempDiv = document.createElement("div");
  tempDiv.appendChild(clone);
  document.body.appendChild(tempDiv);

  // âœ… Optional: include month in filename if monthOutput is available
  const title = document.getElementById("monthOutput")?.textContent || "";
  const safeTitle = title.replace(/\s+/g, '_').replace(/[^\w\-]/g, '');

  const opt = {
    margin:       0.5,
    filename:     `${safeTitle || currentUserName.replace(/\s+/g, '_')}_Timesheet.pdf`,
    image:        { type: 'jpeg', quality: 0.98 },
    html2canvas:  { scale: 2 },
    jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
  };

  html2pdf().set(opt).from(clone).save().then(() => {
    document.body.removeChild(tempDiv);
  });
}

document.addEventListener("DOMContentLoaded", () => {
  const monthInput = document.getElementById("monthSelect");
  const today = new Date();
  monthInput.value = today.toISOString().slice(0, 7);
  loadMonthlyTimesheet();
});
</script>


</body>
</html>
