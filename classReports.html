<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Thaakireen - Class Reports</title>
  <style>
    body {
      margin: 0;
      padding-bottom: 60px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f9f7;
    }

    header, footer {
      background-color: #387a5f;
      color: #fff;
      padding: 10px 20px;
      position: fixed;
      width: 100%;
      z-index: 1000;
    }

    header {
      top: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    footer {
      bottom: 0;
      text-align: center;
    }

    #logo img {
      max-height: 50px;
    }

 #menu-container ul {
            list-style: none;
            display: flex;
            align-items: center;
            gap: 20px;
            margin-right: 50px;
            padding: 0;
        }

        #menu-container a {
            text-decoration: none;
            color: #fff;
            font-weight: bold;
        }


    h1 {
      text-align: center;
      margin-top: 100px;
    }

    .dropdown-container {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin: 40px auto;
      flex-wrap: wrap;
    }

    .dropdown-group {
      display: flex;
      flex-direction: column;
      min-width: 220px;
    }

    .dropdown-group label {
      font-weight: bold;
      margin-bottom: 5px;
      color: #387a5f;
    }

    .dropdown-group select {
      padding: 8px;
      border: 2px solid #387a5f;
      border-radius: 6px;
      font-family: 'Times New Roman', Times, serif;
      background-color: #f9fdfc;
    }

    #reportCard {
      padding: 50px;
      max-width: 800px;
      margin: 40px auto;
      border: 2px solid #387a5f;
      background-color: #fef9e7;
      font-family: 'Times New Roman', Times, serif;
      position: relative;
    }

td, textarea {
  word-wrap: break-word;
  white-space: normal;
}


    .watermark {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 0;
      opacity: 0.07;
      pointer-events: none;
    }

    .report-content {
      position: relative;
      z-index: 1;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    table, th, td {
      border: 1px solid #ccc;
    }

    th {
      background-color: #d0e7de;
    }

    th, td {
  padding: 16px 20px;  /* Was 8px before */
  text-align: center;
}


    button {
      background-color: #387a5f;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      margin: 10px 5px;
    }

    button:hover {
      background-color: #2f6b54;
    }

table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0 20px; /* More vertical spacing between rows */
  margin-top: 30px;
}

th, td {
  padding: 20px 16px;      /* More space above and below text */
  font-size: 16px;
  vertical-align: top;
  background-color: #fffefb;
  border: 1px solid #ccc;
}

th {
  background-color: #d0e7de;
  font-weight: bold;
  text-align: center;
}

td:nth-child(3) {
  line-height: 1.8;        /* Extra space between lines in the comment */
}


#mobileWarning {
  display: none;
  position: fixed;
  z-index: 9999;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: linear-gradient(135deg, #f4f9f7 0%, #d0e7de 100%);
  justify-content: center;
  align-items: center;
  padding: 40px 20px;
  box-sizing: border-box;
}

#mobileWarning .mobile-message {
  background-color: white;
  border: 2px solid #387a5f;
  border-radius: 16px;
  padding: 30px;
  max-width: 400px;
  width: 100%;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
  font-family: 'Segoe UI', sans-serif;
  text-align: center;
  animation: fadeInScale 0.4s ease;
}

.warning-logo {
  max-width: 90px;
  margin-bottom: 15px;
}

.mobile-message h2 {
  color: #2e5e4e;
  margin-bottom: 10px;
}

.mobile-message p {
  font-size: 16px;
  color: #444;
  line-height: 1.6;
  margin: 10px 0 20px;
}

.mobile-message .back-btn {
  padding: 10px 24px;
  background-color: #387a5f;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 15px;
  font-weight: bold;
  cursor: pointer;
  transition: background-color 0.25s ease;
}

.mobile-message .back-btn:hover {
  background-color: #2f654e;
}

@keyframes fadeInScale {
  from {
    opacity: 0;
    transform: scale(0.92);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

/* âœ… Show only on mobile */
@media only screen and (max-width: 767px) {
  #mobileWarning {
    display: flex;
  }

  body > *:not(#mobileWarning) {
    display: none !important;
  }
}
#reportCard {
  width: 100%;
  max-width: 750px; /* Letter size with margin */
  padding: 40px;
  font-size: 12pt;
  background: white;
  margin: 0 auto;
}

#reportCard table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}

#reportCard th, #reportCard td {
  padding: 8px;
  vertical-align: top;
  text-align: left;
}

#reportCard td.comment-cell {
  min-height: 100px;  /* Ensures enough vertical space */
  line-height: 1.5;
}

  </style>
</head>
<body>
 <div id="mobileWarning">
  <div class="mobile-message">
    <img src="uploads/newLogo.png" alt="Thaakireen Logo" class="warning-logo">
    <h2>Mobile Access Limited</h2>
    <p>
      ðŸ“µ This page is best viewed on a <strong>desktop or tablet</strong>.<br>
      Please continue there to view Report Cards.
    </p>
    <button onclick="window.location.href='Homepage.html'" class="back-btn">ðŸ”™ Back to Home</button>
  </div>
</div>

<header>
  <div id="logo"><img src="uploads/Logo.png" alt="Logo"></div>
  <div id="menu-container">
    <ul>
      <li><a href="Homepage.html">Home</a></li>
      <li><a href="Profile.html">My Profile</a></li>
      <li><a href="Login.html">Logout</a></li>
    </ul>
  </div>
</header>

<h1>Report Cards</h1>

<div class="dropdown-container">
  <div class="dropdown-group" id="teacherDropdownGroup">
    <label for="teacherSelect">Select Teacher:</label>
    <select id="teacherSelect"></select>
  </div>
  <div class="dropdown-group">
    <label for="studentSelect">Select Student:</label>
    <select id="studentSelect" onchange="loadReportCard()">
      <option value="">-- Choose Student --</option>
    </select>
  </div>
</div>

<div id="reportCard">
  <div class="watermark"><img src="uploads/newLogo.png" alt="Watermark" style="width: 700px;"></div>

  <div class="report-content">
    <div style="text-align:center;">
      <img src="uploads/newLogo.png" alt="Logo" style="max-width: 300px;"><br>
    
    </div>

    <p><strong>Student Name:</strong> <span id="studentName"></span></p>
    <p><strong>Assigned Teacher:</strong> <span id="teacherName"></span></p>

    <table>
  <thead>
  <!-- Optional main heading centered above the table -->
  <tr>
    <th colspan="3" style="text-align: center; font-size: 20px; padding: 10px; background-color: #f3f3f3;">
            <h3>Student Report Card - <span id="schoolYear">2024/2025</span></h3>
    </th>
  </tr>
  <!-- Table column headers -->
  <tr>
    <th style="text-align: center;">Subject</th>
    <th style="text-align: center;">Grade</th>
    <th style="text-align: center;">Comments</th>
  </tr>
</thead>



<tbody id="reportBody"></tbody>
    </table>

    <div style="margin-top: 30px;">
      <label><strong>Teacher Comments:</strong></label><br>
  
      <textarea id="teacherComments" rows="8" style="width: 100%;"></textarea>
<div id="teacherCommentsDisplay" style="
  white-space: pre-wrap;
  word-wrap: break-word;
  display: none;
  font-size: 16px;
  line-height: 1.6;
  margin-top: 10px;
"></div>



    </div>

<div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
  <p>Teacher's Signature: ______________________</p>
  <p style="display: flex; align-items: center;">
    Principal's Signature:
    <img src="uploads/principal_signature.png" alt="Principal Signature" style="max-height: 100px; margin-left: 20px;">
  </p>
</div>

    </div>

    <button onclick="exportToPDF()">Save Current Student</button>
    <button onclick="exportWholeClass()">Save Whole Class</button>
  </div>
</div>

<footer><p>&copy; 2024 Thaakireen. All rights reserved.</p></footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
let isAdmin = false;
let isTeacher = false;
let teacherId = null;
let studentMap = {};
let allStudents = [];

async function checkUserRole() {
  const res = await fetch("check_user_role.php");
  const data = await res.json();
  isAdmin = data.isAdmin;
  isTeacher = data.isTeacher;
  teacherId = data.teacherId || null;
}

async function populateDropdowns() {
  const res = await fetch("fetch_dropdowns.php");
  const data = await res.json();
  allStudents = data.students || [];
  const teacherSelect = document.getElementById("teacherSelect");
  const studentSelect = document.getElementById("studentSelect");

  // Group students by teacher
  studentMap = {};
  allStudents.forEach(s => {
    if (!studentMap[s.teacher_id]) studentMap[s.teacher_id] = [];
    studentMap[s.teacher_id].push(s);
  });

  if (isAdmin) {
    teacherSelect.innerHTML = `<option value="">-- Select Teacher --</option>`;
    (data.teachers || []).forEach(t => {
      teacherSelect.innerHTML += `<option value="${t.id}">${t.name}</option>`;
    });

    teacherSelect.addEventListener("change", () => {
      const selectedTeacherId = teacherSelect.value;
      populateStudentDropdown(selectedTeacherId);
    });
  } else if (isTeacher) {
    document.getElementById("teacherDropdownGroup").style.display = "none";
    populateStudentDropdown(teacherId);
  }
}

function populateStudentDropdown(filterTeacherId) {
  const studentSelect = document.getElementById("studentSelect");
  studentSelect.innerHTML = `<option value="">-- Choose Student --</option>`;
  const students = studentMap[parseInt(filterTeacherId)] || [];

  students.forEach(s => {
    studentSelect.innerHTML += `<option value="${s.id}">${s.firstName} ${s.lastName}</option>`;
  });

  if (students.length > 0) {
    studentSelect.value = students[0].id;
    loadReportCard(); // Or loadStudentMarks() if that's the intended function
  }
}


function loadReportCard() {
  const studentId = document.getElementById("studentSelect").value;
  if (!studentId) return;

  fetch(`fetch_student_report.php?student_id=${studentId}`)
    .then(res => res.json())
    .then(data => {
      document.getElementById("studentName").textContent = data.studentName;
      document.getElementById("teacherName").textContent = data.teacherName;

      const reportBody = document.getElementById("reportBody");
      reportBody.innerHTML = "";

      getSubjectArray(data).forEach(subject => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td style="text-align: left;">${subject.name}</td>
          <td style="text-align: center;"><strong>${subject.letter}</strong></td>
          <td colspan="2" style="text-align: left;">${subject.comment}</td>`;
        reportBody.appendChild(row);
      });

      // Only generate a random teacher comment if the textarea is empty
      const commentBox = document.getElementById("teacherComments");
      if (!commentBox.value.trim()) {
        generateTeacherComment();
      }
    })
    .catch(err => {
      console.error("Error loading report:", err);
      alert("Failed to load report data.");
    });
}


function getSubjectArray(data) {
  function clean(val) {
    return val !== null && val !== undefined && !isNaN(val) ? Math.round(val) : "N/A";
  }

  function letterGrade(score) {
    if (score === "N/A") return "N/A";
    if (score >= 86) return "A";
    if (score >= 73) return "B";
    if (score >= 67) return "C+";
    if (score >= 60) return "C";
    return "C-";
  }

function comment(letter, subject) {
  if (letter === "N/A") return "No mark available for this subject.";

  const lower = subject.toLowerCase();
  const isMemorization = lower.includes("memorization") || lower.includes("dua");
  const isRecitation = lower.includes("recitation");

  switch (letter) {
    case "A":
      if (isMemorization) return `MashaAllah! Excellent memorization in ${subject}. ðŸŒŸ`;
      if (isRecitation) return `Reads with excellent fluency and confidence in ${subject}. ðŸŒŸ`;
      return `MashaAllah! Excellent performance in ${subject}. ðŸŒŸ`;

    case "B":
      if (isMemorization) return `Good memorization progress in ${subject}, keep it up. ðŸ‘`;
      if (isRecitation) return `Reads well in ${subject}, with minor improvements needed. ðŸ‘`;
      return `Good performance in ${subject}, keep it up. ðŸ‘`;

    case "C+":
      if (isMemorization) return `Satisfactory memorization in ${subject}, more review will help.`;
      if (isRecitation) return `Moderate fluency in ${subject}, with room to grow.`;
      return `Satisfactory in ${subject}, with room to grow.`;

    case "C":
      if (isMemorization) return `Basic memorization in ${subject}. Continued review is encouraged.`;
      if (isRecitation) return `Basic fluency in ${subject}. Needs more practice for smoother reading.`;
      return `Demonstrates a basic understanding of ${subject}. Continued support will help.`;

    case "C-":
      if (isMemorization) return `Struggling with memorization in ${subject}. Extra practice and support recommended.`;
      if (isRecitation) return `Fluency is limited in ${subject}. With practice, improvement is possible.`;
      return `Challenges in ${subject}. Needs support and consistent review to improve.`;

    default:
      return "";
  }
}

  return [
    { name: "Quran Recitation", letter: letterGrade(clean(data.quran?.recitation_score)), comment: comment(letterGrade(clean(data.quran?.recitation_score)), "Quran Recitation") },
    { name: "Surah Memorization", letter: letterGrade(clean(data.quran?.memorization_score)), comment: comment(letterGrade(clean(data.quran?.memorization_score)), "Surah Memorization") },
    { name: "Dua Memorization", letter: letterGrade(clean(data.dua?.score)), comment: comment(letterGrade(clean(data.dua?.score)), "Dua Memorization") },
    { name: "Fiqh", letter: letterGrade(clean(data.fiqh?.score)), comment: comment(letterGrade(clean(data.fiqh?.score)), "Fiqh") },
    { name: "Aqaaâ€™id", letter: letterGrade(clean(data.aqaaid?.score)), comment: comment(letterGrade(clean(data.aqaaid?.score)), "Aqaaâ€™id") },
    { name: "Akhlaaq & Adab", letter: letterGrade(clean(data.akhlaaq?.score)), comment: comment(letterGrade(clean(data.akhlaaq?.score)), "Akhlaaq & Adab") },
    { name: "Ahadeeth", letter: letterGrade(clean(data.ahadeeth?.score)), comment: comment(letterGrade(clean(data.ahadeeth?.score)), "Ahadeeth") },
    { name: "Taareekh", letter: letterGrade(clean(data.taareekh?.score)), comment: comment(letterGrade(clean(data.taareekh?.score)), "Taareekh") }
  ];
}


function generateTeacherComment() {
  const messages = [
    "It was a pleasure having you as a student this year. Keep shining, and we hope to see you in Summer Madrasah, inshaAllah! ðŸŒ¸",
    "Your hard work and bright spirit made this year special. Wishing you a beautiful break â€” see you in Summer Madrasah, inshaAllah! â˜€ï¸",
    "You brought joy and dedication to every class. May your journey in learning continue! Join us for Summer Madrasah, inshaAllah! ðŸ“–"
  ];
  const randomMessage = messages[Math.floor(Math.random() * messages.length)];
  document.getElementById("teacherComments").value = randomMessage;
}


async function exportToPDF() {
  // Copy comments into the display container
  const textarea = document.getElementById("teacherComments");
  const displayDiv = document.getElementById("teacherCommentsDisplay");

  displayDiv.textContent = textarea.value;
  displayDiv.style.display = "block";
  textarea.style.display = "none";

  // Clone the report card for clean export
  const reportCard = document.getElementById("reportCard");
  const clone = reportCard.cloneNode(true);
  clone.querySelectorAll("button").forEach(btn => btn.remove());

  const wrapper = document.createElement("div");
  wrapper.style.position = "fixed";
  wrapper.style.left = "-9999px";
  wrapper.appendChild(clone);
  document.body.appendChild(wrapper);

  // Allow rendering to finish
  await new Promise(r => requestAnimationFrame(() => setTimeout(r, 200)));

  // Render the canvas
  const canvas = await html2canvas(clone, { scale: 4, backgroundColor: "#fff" });
  const imgData = canvas.toDataURL("image/png");

  const pdf = new jspdf.jsPDF("p", "pt", "a4");
  const pageWidth = pdf.internal.pageSize.getWidth();
  const imgWidth = pageWidth - 40;
  const imgHeight = (canvas.height * imgWidth) / canvas.width;

  pdf.addImage(imgData, "PNG", 20, 20, imgWidth, imgHeight, '', 'FAST');

  const name = document.getElementById("studentName").textContent.trim().replace(/\s+/g, "_") || "Report";
  pdf.save(`${name}_Report_Card.pdf`);

  // Reset display
  document.body.removeChild(wrapper);
  displayDiv.style.display = "none";
  textarea.style.display = "block";
}


async function exportWholeClass() {
  const selectedTeacherId = isAdmin
    ? document.getElementById("teacherSelect").value
    : teacherId; // Global teacherId from session

  if (!selectedTeacherId) return alert("Please select a teacher.");

  const res = await fetch("fetch_dropdowns.php");
  const data = await res.json();
  const students = isAdmin
    ? data.students.filter(s => s.teacher_id == selectedTeacherId)
    : data.students.filter(s => s.teacher_id == teacherId);

  for (const student of students) {
    document.getElementById("studentSelect").value = student.id;

    await loadReportCard();
    generateTeacherComment();

    await new Promise(resolve =>
      requestAnimationFrame(() => setTimeout(resolve, 500))
    );

    await exportToPDF();
  }

  alert("âœ… All student PDFs saved.");
}
window.addEventListener("DOMContentLoaded", async () => {
  await checkUserRole();
  await populateDropdowns();

  // Attach event listener after dropdowns are ready
  const studentDropdown = document.getElementById("studentSelect");
  studentDropdown.addEventListener("change", async () => {
    await loadReportCard();
    generateTeacherComment();
  });
});

</script>

</body>
</html>
