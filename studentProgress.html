<!-- Updated Student Progress Page with Proper Surah/Dua Retention -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thaakireen - Student Progress</title>
   
<style>
:root {
  --primary: #387a5f;
  --dark: #2e5e4e;
  --light-bg: #f4f9f7;
}

body {
  margin: 0;
  padding-bottom: 60px;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background-color: var(--light-bg);
}

/* Header and Footer */
header, footer {
  background-color: var(--primary);
  color: #fff;
  padding: 10px 20px;
  width: 100%;
  position: fixed;
  z-index: 1000;
}

header {
  top: 0;
}

footer {
  bottom: 0;
  text-align: center;
}

/* Header Layout */
#header-inner {
  display: flex;
  margin-right: 30px;
  align-items: center;
  justify-content: space-between;
  width: 100%;
}

#logo img {
  max-height: 50px;
}

#main-nav {
  display: flex;
  justify-content: flex-end;
  flex-grow: 1;
}

#main-menu {
  list-style: none;
  display: flex;
  margin: 0;
}

#main-menu li a {
  text-decoration: none;
  color: white;
  font-weight: bold;
  padding: 10px;
  margin-right: 30px;
  transition: 0.3s;
}

#main-menu li a:hover {
  text-decoration: underline;
}

/* Burger Button */
#menu-toggle {
  display: none;
  font-size: 28px;
  background: none;
  border: none;
  color: white;
  cursor: pointer;
}

  h1 {
    text-align: center;
    font-size: 26px;
    color: var(--dark);

  }

  .controls {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 20px;
    justify-content: flex-start;
  }

  label {
    font-weight: 600;
  }

  select, input, button {
    padding: 8px 12px;
    font-size: 15px;
    border: 1px solid #ccc;
    border-radius: 6px;
  }

  button {
    cursor: pointer;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }

  th, td {
    padding: 14px;
    text-align: center;
    border: 1px solid #ddd;
    font-size: 14px;
  }

  th {
    background-color: #d0e7de;
    font-weight: bold;
  }

  td.name-cell {
    text-align: left;
  }

  tr:nth-child(even) {
    background-color: #f9f9f9;
  }

  .Progress-form {
  max-width: 1500px;
  margin: 80px;
  margin-top: 100px;
  padding: 20px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

  .Progress-form label {
    font-weight: bold;
    margin-bottom: 5px;
    display: block;
  }

  .Progress-form select,
  .Progress-form input {
    width: 100%;
    padding: 10px;
    font-size: 16px;
    margin-bottom: 15px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }

  .Progress-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 30px;
  }

  .Progress-table th, .Progress-table td {
    border: 1px solid #387a5f;
    padding: 12px;
    text-align: center;
    font-size: 12px;
  }

  .Progress-table td:first-child,
  .Progress-table td:nth-child(3),
  .Progress-table td:nth-child(4),
  .Progress-table td.surah-goal,
  .Progress-table td.dua-goal {
    text-align: left;
  }

  .Progress-table th {
    background-color: #e7f3ec;
    color: #387a5f;
    font-size: 12px;
  }

  .submit-button {
    background-color: #387a5f;
    color: white;
    padding: 12px 24px;
    font-size: 16px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    margin-top: 20px;
  }

  .submit-button:hover {
    background-color: #2f654e;
  }

  @media (max-width: 768px) {
    #main-menu {
      display: none;
      flex-direction: column;
      background-color: var(--primary);
      position: absolute;
      top: 60px;
      right: 0;
      width: 100%;
      padding: 10px 0;
    }

    #main-menu.show {
      display: flex;
    }

    #main-menu li {
      text-align: center;
      padding: 10px 0;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    #menu-toggle {
      display: block;
      margin-left: 210px;
    }

    .Progress-form, main.container {
      margin: 100px 10px 60px;
      padding: 20px;
    }

    .controls {
      flex-direction: column;
    }

    table {
      display: block;
      overflow-x: auto;
      white-space: nowrap;
    }

    th, td {
      font-size: 13px;
    }

    h1 {
      font-size: 22px;
    }
  }
</style>

    

</head>
<body>


   <header>
  <div id="header-inner">
    <div id="logo"><img src="uploads/Logo.png" alt="Thaakireen Logo"></div>
    <button id="menu-toggle">&#9776;</button>
    <nav>
      <ul id="main-menu">
        <li><a href="Homepage.html">Home</a></li>
        <li><a href="Profile.html">My Profile</a></li>
        <li><a href="Login.html">Logout</a></li>
      </ul>
    </nav>
  </div>
</header>


<div class="Progress-form">
    <h1>Student Progress</h1>

    <!-- Shown only for Admins/Examiners -->
    <div id="teacherFilterSection" style="display: none;">
        <label for="teacherSelect"><strong>Select Teacher:</strong></label>
        <select id="teacherSelect">
            <option value="">-- Select Teacher --</option>
        </select>
    </div>

    <!-- Always visible -->
    <label for="schoolYear"><strong>Select School Year:</strong></label>
    <select id="schoolYear">
        <option value="">Select Year</option>
        <option value="2022/2023">2022/2023</option>
        <option value="2023/2024">2023/2024</option>
        <option value="2024/2025">2024/2025</option>
        <option value="2025/2026">2025/2026</option>
    </select>

    <!-- Only needed for Admin/Examiner mode -->
    <button id="filterBtn" class="submit-button" style="display: none;">View Progress</button>



    <div style="margin-bottom: 10px;">
        <button class="submit-button" onclick="exportToPDF()">Save Current Class</button>
        <button class="submit-button" onclick="exportWholeClass()">Save All Classes</button>
          <table id="progressTable" class="Progress-table">
        <thead>
            <tr>
                <th>Student Name</th>
                <th>Gr.</th>
                <th>Last Surah</th>
                <th>Last Dua</th>
                <th>Reading Material</th>
                <th>Qaida Page</th>
                <th>Book Grade</th>
                <th>Surah Goal</th>
                <th>Dua Goal</th>
                <th>Notes</th>
                <th>Last Updated</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="progressTableBody"></tbody>
    </table>
    </div>


</div>


<div id="editModal" style="
    display: none;
    position: fixed;
    top: 40%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    z-index: 2000;
    width: 450px;
    max-width: 90%;
">
    <h3>Edit Student Progress</h3>

    <!-- Hidden IDs for tracking -->
    <input type="hidden" id="editStudentId">
    <input type="hidden" id="originalSurahId">
    <input type="hidden" id="originalDuaId">
    

    <!-- Last Surah -->
    <label for="editSurahId">Last Surah:</label>
    <select id="editSurahId">
        <option value="">-- Select Surah --</option>
    </select><br><br>

    <!-- Last Dua -->
    <label for="editDuaId">Last Dua:</label>
    <select id="editDuaId">
        <option value="">-- Select Dua --</option>
    </select><br><br>

    <!-- Reading Material -->
    <label for="editReading">Reading Material:</label>
    <select id="editReading">
        <option value="Quran">Quran</option>
        <option value="Qaida">Qaida</option>
    </select><br><br>

    <!-- Qaida Page -->
    <label for="editQaidaPage">Qaida Page:</label>
    <input type="number" id="editQaidaPage"><br><br>

    <!-- Book Grade -->
    <label for="editBookGrade">Book Grade:</label>
    <input type="text" id="editBookGrade"><br><br>

    <!-- Notes -->
    <label for="editNotes">Notes:</label>
    <input type="text" id="editNotes"><br><br>

    <!-- Buttons -->
    <button onclick="submitUpdate()">Save</button>
    <button onclick="document.getElementById('editModal').style.display='none'">Cancel</button>
</div>

<footer>
    
    <p>&copy; 2024 Thaakireen. All rights reserved.

</p></footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<!-- Required libraries (order matters) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>


    <script>
        async function exportToPDF() {
  const originalTable = document.getElementById("progressTable");
  if (!originalTable) {
    alert("Table not found.");
    return;
  }

  const clonedTable = originalTable.cloneNode(true);

  // Remove "Notes" and "Last Updated" columns
  const headerCells = clonedTable.querySelectorAll("thead th");
  const indicesToRemove = [];
  headerCells.forEach((th, idx) => {
    const label = th.textContent.trim().toLowerCase();
    if (label.includes("notes") || label.includes("updated")) {
      indicesToRemove.push(idx);
      th.remove();
    }
  });

  clonedTable.querySelectorAll("tbody tr").forEach(row => {
    indicesToRemove.forEach(idx => {
      if (row.children[idx]) row.children[idx].remove();
    });
  });

  // Hide the Actions column
  const lastHeader = clonedTable.querySelector("thead th:last-child");
  if (lastHeader) lastHeader.style.display = "none";
  clonedTable.querySelectorAll("tbody td:last-child").forEach(td => {
    td.style.display = "none";
  });

  // Set thin borders and align selected columns to the left
  const leftAlignIndices = [0, 2, 3, 7, 8]; // Student, Last Surah, Last Dua, Surah Goal, Dua Goal

  clonedTable.style.borderCollapse = "collapse";
  clonedTable.style.width = "100%";
  clonedTable.style.margin = "0";
  clonedTable.style.fontSize = "4px";

  clonedTable.querySelectorAll("td, th").forEach((cell, i) => {
  const colIndex = Array.from(cell.parentNode.children).indexOf(cell);
  cell.style.border = "0.1px solid #ccc";
  cell.style.padding = "6px 4px"; // ⬅️ increased vertical padding
  cell.style.fontSize = "6px";    // ⬅️ slightly larger text
  cell.style.lineHeight = "1.4";  // ⬅️ more spacing between lines
  cell.style.verticalAlign = "middle";
  cell.style.textAlign = leftAlignIndices.includes(colIndex) ? "left" : "center";
});


  // Header above table
  const teacherName = document.getElementById("teacherSelect")?.selectedOptions[0]?.textContent || "Unknown Teacher";

  const headerDiv = document.createElement("div");
  headerDiv.style.display = "flex";
  headerDiv.style.justifyContent = "space-between";
  headerDiv.style.fontSize = "5px";
  headerDiv.style.fontFamily = "sans-serif";
  headerDiv.style.marginBottom = "3px";
  headerDiv.style.fontWeight = "bold";

  const title = document.createElement("div");
  title.textContent = `Student Progress - ${new Date().toLocaleDateString()}`;
  const teacher = document.createElement("div");
  teacher.textContent = `Teacher: ${teacherName}`;

  headerDiv.appendChild(title);
  headerDiv.appendChild(teacher);

  const container = document.createElement("div");
  container.appendChild(headerDiv);
  container.appendChild(clonedTable);
  container.style.margin = "0";
  container.style.padding = "0";

  const wrapper = document.createElement("div");
  wrapper.style.position = "absolute";
  wrapper.style.left = "-9999px";
  wrapper.appendChild(container);
  document.body.appendChild(wrapper);

  const canvas = await html2canvas(container, {
    scale: 3,
    backgroundColor: "#fff"
  });

  const imgData = canvas.toDataURL("image/png");
  const pdf = new jspdf.jsPDF({
    orientation: "landscape",
    unit: "pt",
    format: "letter"
  });

  const margin = 15;
  const imgWidth = pdf.internal.pageSize.getWidth() - margin * 2;
  const imgHeight = (canvas.height * imgWidth) / canvas.width;

  pdf.addImage(imgData, "PNG", margin, margin, imgWidth, imgHeight);
  pdf.save(`Student_Progress_${new Date().toISOString().slice(0, 10)}.pdf`);

  document.body.removeChild(wrapper);
}

let isAdmin = false;
let isExaminer = false;
let isTeacher = false;
let currentUserId = null;
let selectedTeacherId = null;
let selectedSchoolYear = null;

fetch("check_student_access.php")
  .then(res => res.json())
  .then(data => {
    isAdmin = data.isAdmin;
    isExaminer = data.isExaminer;
    isTeacher = data.isTeacher;
currentUserId = data.teacherId; // ✅ Now this is the correct teacher ID


    const yearSelect = document.getElementById("schoolYear");
    const teacherSection = document.getElementById("teacherFilterSection");
    const filterBtn = document.getElementById("filterBtn");

    if (data.showFilter) {
      teacherSection.style.display = "block";
      filterBtn.style.display = "inline-block";
      loadTeachers();
    } else {
      teacherSection.style.display = "none";
      filterBtn.style.display = "none";

      yearSelect.addEventListener("change", () => {
        const year = yearSelect.value;
        if (year) {
          selectedTeacherId = data.teacherId;
          selectedSchoolYear = year;
          loadStudentsByTeacher(selectedTeacherId, year);
        }
      });
    }

    // ✅ Always attach this after setup (for admins/examiners)
    filterBtn.addEventListener("click", () => {
      const year = document.getElementById("schoolYear").value;
      const teacherId = document.getElementById("teacherSelect")?.value;

      if (!year) return alert("Please select a school year.");
      if (!teacherId) return alert("Please select a teacher.");

      selectedTeacherId = teacherId;
      selectedSchoolYear = year;

      loadStudentsByTeacher(teacherId, year);
    });
  });

  function loadTeachers() {
  fetch("fetch_dropdowns.php")
    .then(res => res.json())
    .then(data => {
      const teacherSelect = document.getElementById("teacherSelect");
      teacherSelect.innerHTML = '<option value="">-- Select Teacher --</option>';
      data.teachers.forEach(t => {
        teacherSelect.appendChild(new Option(t.name, t.id));
      });

      // Optional: auto-load students for first teacher if needed
      const firstOption = teacherSelect.options[1];
      if (firstOption) {
        teacherSelect.value = firstOption.value;
        selectedTeacherId = firstOption.value;
        const year = document.getElementById("schoolYear").value;
        if (year) {
          selectedSchoolYear = year;
          loadStudentsByTeacher(selectedTeacherId, year);
        }
      }
    });
}



function loadStudentsByTeacher(teacherId, year) {
  const tbody = document.getElementById("progressTableBody");
  tbody.innerHTML = "";

  fetch(`get_student_progress.php?teacher_id=${teacherId}&school_year=${year}`)
    .then(res => res.json())
    .then(data => {
      const students = data.students || [];

      if (students.length === 0) {
        tbody.innerHTML = `<tr><td colspan="12" style="text-align:center;color:gray;">No students found.</td></tr>`;
        return;
      }

      students.forEach(s => {
        const canEdit = isAdmin || isExaminer || s.teacher_user_id == currentUserId;
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${s.firstName} ${s.lastName}</td>
          <td>${s.school_grade_id ?? '-'}</td>
          <td>${s.lastMemorizedSurah ?? '-'}</td>
          <td>${s.lastMemorizedDua ?? '-'}</td>
          <td>${s.readingMaterial ?? '-'}</td>
          <td>${s.qaidaPage ?? '-'}</td>
          <td>${s.book_grade_id ?? '-'}</td>
          <td class="surah-goal">${s.surah_goal ? `${s.surahGoalMet ? '✅' : '❌'} ${s.surah_goal}` : '—'}</td>
          <td class="dua-goal">${s.dua_goal ? `${s.duaGoalMet ? '✅' : '❌'} ${s.dua_goal}` : '—'}</td>
          <td>${s.notes ?? '-'}</td>
          <td>${s.updatedAt ? new Date(s.updatedAt).toLocaleDateString() : '-'}</td>
          <td>
            <button data-student="${encodeURIComponent(JSON.stringify(s))}" onclick="openEdit(JSON.parse(decodeURIComponent(this.dataset.student)))">Edit</button>

          </td>
        `;
        tbody.appendChild(row);
      });
    })
    .catch(err => {
      console.error("Failed to fetch students:", err);
    });
}

function openEdit(student) {
  // No access check needed since visibility is already restricted server-side

  // Prefill modal data
  document.getElementById('editStudentId').value = student.id;
  document.getElementById('originalSurahId').value = student.last_memorized_surah_id ?? '';
  document.getElementById('originalDuaId').value = student.last_memorized_dua_id ?? '';

  fetch('fetch_dropdowns.php')
    .then(res => res.json())
    .then(data => {
      const surahSelect = document.getElementById('editSurahId');
      const duaSelect = document.getElementById('editDuaId');

      surahSelect.innerHTML = '<option value="">-- Select Surah --</option>';
      duaSelect.innerHTML = '<option value="">-- Select Dua --</option>';

      data.surahs.forEach(surah => {
        const option = document.createElement('option');
        option.value = surah.id;
        option.textContent = surah.name;
        if (parseInt(student.last_memorized_surah_id) === surah.id) {
          option.selected = true;
        }
        surahSelect.appendChild(option);
      });

      data.duas.forEach(dua => {
        const option = document.createElement('option');
        option.value = dua.id;
        option.textContent = dua.dua_name;
        if (parseInt(student.last_memorized_dua_id) === dua.id) {
          option.selected = true;
        }
        duaSelect.appendChild(option);
      });

      document.getElementById('editReading').value = student.readingMaterial || '';
      document.getElementById('editQaidaPage').value = student.qaidaPage || '';
      document.getElementById('editBookGrade').value = student.book_grade_id || '';
      document.getElementById('editNotes').value = student.notes || '';

      document.getElementById('editModal').style.display = 'block';
    });
}

        
        function submitUpdate() {
  const surahSelect = document.getElementById('editSurahId');
  const duaSelect = document.getElementById('editDuaId');

  const selectedSurah = surahSelect.value;
  const selectedDua = duaSelect.value;

  const originalSurah = document.getElementById('originalSurahId').value;
  const originalDua = document.getElementById('originalDuaId').value;

  const surahValue = selectedSurah !== "" ? parseInt(selectedSurah) : (originalSurah ? parseInt(originalSurah) : null);
  const duaValue = selectedDua !== "" ? parseInt(selectedDua) : (originalDua ? parseInt(originalDua) : null);

  const data = {
    id: document.getElementById('editStudentId').value,
    last_memorized_surah_id: surahValue,
    last_memorized_dua_id: duaValue,
    readingMaterial: document.getElementById('editReading').value,
    qaidaPage: document.getElementById('editQaidaPage').value || null,
    book_grade: document.getElementById('editBookGrade').value || '',
    notes: document.getElementById('editNotes').value || ''
  };

  fetch('update_student_progress.php', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  })
    .then(res => res.text())
    .then(text => {
      console.log("Raw response:", text);
      const json = JSON.parse(text);
      alert(json.message || 'Updated successfully');
      document.getElementById('editModal').style.display = 'none';

      // ✅ Use previously selected teacher + year
      if (!selectedTeacherId || !selectedSchoolYear) {
        alert("Missing selected teacher or year");
        return;
      }

      // ✅ Reload student list for the same teacher and year
      loadStudentsByTeacher(selectedTeacherId, selectedSchoolYear);
    })
    .catch(err => {
      console.error('Update failed:', err);
      alert("❌ Update failed. See console.");
    });
}

        
    </script>
    
<script>
  document.getElementById("menu-toggle").addEventListener("click", () => {
    document.getElementById("main-menu").classList.toggle("show");
  });
</script>


</body>
</html>
