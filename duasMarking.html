<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thaakireen - Duaa Exam</title>
    <style>
    
      body {
      margin: 0;
      padding-bottom: 60px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f9f7;
    }

        header, footer {
            background-color: #387a5f;
            color: #fff;
        }

        header {
            padding: 10px 20px;
            position: fixed;
            top: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
        }

        footer {
            padding: 10px;
            text-align: center;
            position: fixed;
            bottom: 0;
            width: 100%;
            z-index: 1000;
        }

        #logo img {
            max-width: 100px;
            height: auto;
        }

       #menu-container ul {
            list-style: none;
            display: flex;
            align-items: center;
            gap: 20px;
            margin-right: 50px;
            padding: 0;
        }

        #menu-container a {
            text-decoration: none;
            color: #fff;
            font-weight: bold;
        }


        h1 {
            text-align: center;
            margin-top: 120px;
            font-size: 32px;
            color: #2f654e;
        }

        .exam-form {
            max-width: 1400px;
            margin: 0 auto;
            margin-bottom: 90px;
            padding: 20px 40px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .exam-form label {
            display: block;
            margin-top: 15px;
            margin-left: 50px;
            font-size: 16px;
            color: #333;
        }

        .exam-form select,
        .exam-form input[type="date"] {
            width: 70%;
            padding: 8px;
            margin-top: 5px;
            margin-left: 50px;
            font-size: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .exam-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .exam-table th, .exam-table td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: center;
        }

        .exam-table th {
            background-color: #e7f3ec;
            color: #387a5f;
        }

        .exam-table td:first-child {
            text-align: left;
            font-weight: 500;
        }

        .exam-table td .meta {
            font-size: 12px;
            color: gray;
        }

        .right-align {
            text-align: right;
            padding-right: 10px;
        }

        button {
            background-color: #387a5f;
            color: white;
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            margin-top: 20px;
            margin-right: 10px;
            cursor: pointer;
        }

        .submit-button:hover {
            background-color: #2f654e;
        }

        .disabled-row {
            background-color: #f0f0f0 !important;
            color: #999 !important;
        }

        input[type="checkbox"] {
            transform: scale(1.2);
            accent-color: #387a5f;
        }

        .exam-table td input[type="number"] {
            width: 90%;
            padding: 4px;
            text-align: center;
        }

        #studentSelect {
  background-color: white;
  color: #000;
}

        .exam-table input[type="checkbox"] {
            transform: scale(1.3);
        }

        /* Remove the emoji circles */
        .exam-table td .meta::before {
            content: "Arabic: ";
            color: #387a5f;
        }
        .exam-table td .meta::after {
            content: " | English: " attr(data-translation);
            color: #b36b00;
        }


#mobileWarning {
  display: none;
  position: fixed;
  z-index: 9999;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: linear-gradient(135deg, #f4f9f7 0%, #d0e7de 100%);
  justify-content: center;
  align-items: center;
  padding: 40px 20px;
  box-sizing: border-box;
}

#mobileWarning .mobile-message {
  background-color: white;
  border: 2px solid #387a5f;
  border-radius: 16px;
  padding: 30px;
  max-width: 400px;
  width: 100%;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
  font-family: 'Segoe UI', sans-serif;
  text-align: center;
  animation: fadeInScale 0.4s ease;
}

.warning-logo {
  max-width: 90px;
  margin-bottom: 15px;
}

.mobile-message h2 {
  color: #2e5e4e;
  margin-bottom: 10px;
}

.mobile-message p {
  font-size: 16px;
  color: #444;
  line-height: 1.6;
  margin: 10px 0 20px;
}

.mobile-message .back-btn {
  padding: 10px 24px;
  background-color: #387a5f;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 15px;
  font-weight: bold;
  cursor: pointer;
  transition: background-color 0.25s ease;
}

.mobile-message .back-btn:hover {
  background-color: #2f654e;
}

@keyframes fadeInScale {
  from {
    opacity: 0;
    transform: scale(0.92);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

/* ✅ Show only on mobile */
@media only screen and (max-width: 767px) {
  #mobileWarning {
    display: flex;
  }

  body > *:not(#mobileWarning) {
    display: none !important;
  }
}

    </style>
 
</head>
<body>

 <div id="mobileWarning">
  <div class="mobile-message">
    <img src="uploads/Logo.png" alt="Thaakireen Logo" class="warning-logo">
    <h2>Mobile Access Limited</h2>
    <p>
      📵 This page is best viewed on a <strong>desktop or tablet</strong>.<br>
      Please continue there to complete the Duaa Exam.
    </p>
    <button onclick="window.location.href='Homepage.html'" class="back-btn">🔙 Back to Home</button>
  </div>
</div>



<header>
    <div id="logo">
        <img src="uploads/Logo.png" alt="Thaakireen Logo">
    </div>
    <div id="menu-container">
        <ul>
            <li><a href="Homepage.html">Home</a></li>
            <li><a href="Profile.html">My Profile</a></li>
            <li><a href="Login.html">Logout</a></li>
        </ul>
    </div>
</header>

<div class="exam-form">
    <h1>Duaa Exam</h1>
    <label for="examDate">Exam Date:</label>
    <input type="date" id="examDate" name="examDate">

    <label for="studentName">Student Name:</label>
    <select id="studentName" name="studentName">
        <option value="">Select Student</option>
    </select>

    <label for="teacher">Teacher:</label>
    <select id="teacher" name="teacher">
        <option value="">Select Teacher</option>
    </select>

    <label for="examiner">Examiner:</label>
    <select id="examiner" name="examiner">
        <option value="">Select Examiner</option>
    </select>

    <label for="grade">Grade:</label>
    <select id="grade" name="grade">
        <option value="">Select Grade</option>
        <option value="Kindergarten">Kindergarten</option>
        <option value="Grade 1">Grade 1</option>
        <option value="Grade 2">Grade 2</option>
        <option value="Grade 3">Grade 3</option>
        <option value="Grade 4">Grade 4</option>
        <option value="Grade 5">Grade 5</option>
        <option value="Grade 6">Grade 6</option>
        <option value="Grade 7">Grade 7</option>
        <option value="Grade 8">Grade 8</option>
        <option value="Grade 9">Grade 9</option>
        <option value="Grade 10">Grade 10</option>
        <option value="Grade 11">Grade 11</option>
        <option value="Grade 12">Grade 12</option>
    </select>


    <table class="exam-table">
    <thead>
        <tr>
            <th>Duaa Title</th>
            <th>Arabic Correct - 85%</th>
            <th>Translation Correct - 15%</th>
            <th>Weighted - 100%</th>
            <th>Skip Arabic</th>
            <th>Skip English</th>
            <th>Not Reached</th>
        </tr>
    </thead>
    <tbody id="duaaTableBody"></tbody>
    <tfoot style="font-size: 14px;">
    <tr>
        <td colspan="3" style="text-align: left; font-weight: bold;">Total Weighted Score:</td>
        <td colspan="4" id="totalWeighted">%</td>
    </tr>
    <tr>
        <td colspan="3" style="text-align: left; font-weight: bold;">Bonus:</td>
        <td colspan="4"><input type="number" id="bonus" style="width: 80%; font-size: 14px;"></td>
    </tr>
    <tr>
        <td colspan="3" style="text-align: left; font-weight: bold;">Deductions:</td>
        <td colspan="4"><input type="number" id="deductions" style="width: 80%; font-size: 14px;"></td>
    </tr>
</tfoot>

</table>

<button id="submitBtn" class="submit-button">Submit</button>
<button id="updateBtn" style="display:none;" class="submit-button">Update</button>
<button id="newExamBtn" style="display:none;">New Exam</button>


    <button class="submit-button" onclick="exportToPDF()">Save Current Student</button>
    <button class="submit-button" onclick="exportWholeClass()">Save Whole Class</button>
    
</div>

<footer>
    <p>&copy; 2024 Thaakireen. All rights reserved.</p>
</footer>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<!-- Required libraries (order matters) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
        async function exportToPDF() {
  const originalTable = document.querySelector(".exam-table");
  if (!originalTable) return alert("Table not found.");

  const studentName = document.getElementById("studentName")?.selectedOptions[0]?.textContent || "Student";
  const teacherName = document.getElementById("teacher")?.selectedOptions[0]?.textContent || "Teacher";
  const finalScore = document.getElementById("totalWeighted")?.textContent || "0%";

  const pageGroups = {
    1: ["Kindergarten", "Grade 1", "Grade 2", "Grade 3"],
    2: ["Grade 4", "Grade 5", "Grade 6" ,"Grade 7" ],
    3: ["Grade 7", "Grade 8", "Grade 9", "Grade 10"]
  };

  const pdf = new jspdf.jsPDF("p", "pt", "letter");
  const margin = 4;
  let pageCount = 0;

  for (const group of Object.values(pageGroups)) {
    const table = originalTable.cloneNode(false);
    const thead = originalTable.querySelector("thead").cloneNode(true);
    const tbody = document.createElement("tbody");
    let include = false;

    originalTable.querySelectorAll("tr").forEach(tr => {
      const heading = tr.querySelector("td[colspan]");
      if (heading) {
        include = group.includes(heading.textContent.trim());
        if (include) tbody.appendChild(tr.cloneNode(true));
      } else if (include) {
        tbody.appendChild(tr.cloneNode(true));
      }
    });

    if (tbody.children.length === 0) continue;

    table.appendChild(thead);
    table.appendChild(tbody);

    table.querySelectorAll("input").forEach(input => {
      const span = document.createElement("span");
      span.textContent = input.type === "checkbox" ? (input.checked ? "✓" : "") : input.value;
      span.style.fontSize = "6px";
      span.style.fontFamily = "'Times New Roman', serif";
      span.style.display = "inline-block";
      span.style.minWidth = "28px";
      span.style.textAlign = "center";
      input.parentNode.replaceChild(span, input);
    });

    table.style.fontSize = "6px";
    table.style.borderCollapse = "collapse";
    table.style.width = "100%";
    table.style.margin = "0";
    table.style.padding = "0";
    table.querySelectorAll("td, th").forEach(cell => {
      cell.style.fontSize = "6px";
      cell.style.fontFamily = "'Times New Roman', serif";
      cell.style.fontWeight = "300";
      cell.style.padding = "2px 3px";
      cell.style.border = "0.4px solid #bbb";
      cell.style.lineHeight = "1.1";
    });

    // ✅ Remove score div under title
    table.querySelectorAll("td div").forEach(div => {
      if (div.textContent.includes("Arabic") || div.textContent.includes("English")) {
        div.remove();
      }
    });

    const headerDiv = document.createElement("div");
    headerDiv.style.display = "flex";
    headerDiv.style.justifyContent = "space-between";
    headerDiv.style.fontSize = "6px";
    headerDiv.style.fontFamily = "'Times New Roman', serif";
    headerDiv.style.fontWeight = "300";
    headerDiv.style.marginBottom = "3px";

    const studentDiv = document.createElement("div");
    studentDiv.textContent = `Student: ${studentName}`;
    const teacherDiv = document.createElement("div");
    teacherDiv.textContent = `Teacher: ${teacherName}`;
    headerDiv.appendChild(studentDiv);
    headerDiv.appendChild(teacherDiv);

    const container = document.createElement("div");
    container.appendChild(headerDiv);
    container.appendChild(table);
    container.style.padding = `${margin}px`;
    container.style.background = "#fff";
    container.style.fontFamily = "'Times New Roman', serif";

    const wrapper = document.createElement("div");
    wrapper.style.position = "absolute";
    wrapper.style.left = "-9999px";
    wrapper.appendChild(container);
    document.body.appendChild(wrapper);

    const canvas = await html2canvas(container, {
      scale: 3,
      backgroundColor: "#fff",
      useCORS: true,
      windowWidth: container.scrollWidth,
      windowHeight: container.scrollHeight,
    });

    const imgData = canvas.toDataURL("image/png");
    const pageWidth = pdf.internal.pageSize.getWidth() - margin * 2;
    const imgHeight = (canvas.height * pageWidth) / canvas.width;

    if (pageCount > 0) pdf.addPage();
    pdf.addImage(imgData, "PNG", margin, margin, pageWidth, imgHeight);
    pageCount++;

    document.body.removeChild(wrapper);
  }

  // ✅ Add summary (final score only)
  const summaryTable = document.createElement("table");
  summaryTable.style.fontSize = "6px";
  summaryTable.style.fontFamily = "'Times New Roman', serif";
  summaryTable.style.borderCollapse = "collapse";
  summaryTable.style.marginTop = "3px";
  summaryTable.style.width = "100%";
  summaryTable.innerHTML = `
    <tr>
      <td style="padding: 3px;">Final Score:</td>
      <td>${finalScore}</td>
    </tr>
  `;

  const summaryWrapper = document.createElement("div");
  summaryWrapper.style.padding = `${margin}px`;
  summaryWrapper.style.fontFamily = "'Times New Roman', serif";
  summaryWrapper.appendChild(summaryTable);
  document.body.appendChild(summaryWrapper);

  const summaryCanvas = await html2canvas(summaryWrapper, {
    scale: 3,
    backgroundColor: "#fff",
    useCORS: true,
  });

  const summaryImg = summaryCanvas.toDataURL("image/png");
  pdf.addPage();
  pdf.addImage(summaryImg, "PNG", margin, margin, pdf.internal.pageSize.getWidth() - margin * 2, (summaryCanvas.height * (pdf.internal.pageSize.getWidth() - margin * 2)) / summaryCanvas.width);

  document.body.removeChild(summaryWrapper);

  const fileName = `${studentName.replace(/\s+/g, "_")}_Duaa_Exam.pdf`;
  pdf.save(fileName);
}



    let isAdmin = false;
    let isExaminer = false;
    let isTeacher = false;
    let teacherId = null;
    let isUpdate = false;
    let studentMap = {};

    
    const studentSelect = document.getElementById("studentName");
    const submitBtn = document.getElementById("submitBtn");
    const updateBtn = document.getElementById("updateBtn");
    const newExamBtn = document.getElementById("newExamBtn");

    
    window.addEventListener("DOMContentLoaded", async () => {
        await checkUserRole();
        await loadDropdowns();
        loadDuaTable();
        attachSubmitHandler();
    
        if (isTeacher && !isAdmin && !isExaminer) {
            submitBtn.style.display = "none";
            newExamBtn.style.display = "none";
        }
    });
    
    async function checkUserRole() {
        const res = await fetch("check_user_role.php");
        const data = await res.json();
        isAdmin = data.isAdmin;
        isExaminer = data.isExaminer;
        isTeacher = data.isTeacher;
        teacherId = data.teacherId;

    }

    function ensureOption(select, value, label) {
    if (!select || !value) return;

    const exists = [...select.options].some(opt => opt.value == value);
    if (!exists) {
        const opt = new Option(label || `ID ${value}`, value);
        select.appendChild(opt);
    }
}

    
    async function loadDropdowns() {
        const res = await fetch("fetch_dropdowns.php");
        const data = await res.json();
    
        const teacherSelect = document.getElementById("teacher");
        const examinerSelect = document.getElementById("examiner");
    
        studentSelect.innerHTML = '<option value="">Select Student</option>';
    
        const studentList = isTeacher && !isAdmin && !isExaminer
            ? data.students.filter(s => s.teacher_id == teacherId)
            : data.students;
    
 studentList.forEach(student => {
  const fullName = `${student.firstName} ${student.lastName}`;
  const option = new Option(fullName, student.id);
  studentSelect.appendChild(option);
  studentMap[student.id] = student;
});


    
        if (!isTeacher || isAdmin || isExaminer) {
            teacherSelect.innerHTML = '<option value="">Select Teacher</option>';
            examinerSelect.innerHTML = '<option value="">Select Examiner</option>';
            data.teachers.forEach(t => {
                teacherSelect.appendChild(new Option(t.name, t.id));
                examinerSelect.appendChild(new Option(t.name, t.id));
            });
        } else {
            teacherSelect.style.display = "none";
            examinerSelect.style.display = "none";
            document.querySelector("label[for='teacher']").style.display = "none";
            document.querySelector("label[for='examiner']").style.display = "none";
        }
    }
    
  studentSelect.addEventListener("change", async () => {
    const studentId = studentSelect.value;
    if (!studentId || !studentMap[studentId]) return;

    const student = studentMap[studentId];
    const year = new Date().getFullYear();

    const gradeSelect = document.getElementById("grade");
    const teacherSelect = document.getElementById("teacher");
    const examinerSelect = document.getElementById("examiner");
    const examDate = document.getElementById("examDate");
    const bonusInput = document.getElementById("bonus");
    const deductionsInput = document.getElementById("deductions");
    const totalWeightedDisplay = document.getElementById("totalWeighted");

    ensureOption(gradeSelect, student.school_grade, student.school_grade);
    gradeSelect.value = student.school_grade || "";
    gradeSelect.disabled = true;

    ensureOption(teacherSelect, student.teacher_id, student.teacher_name);
    teacherSelect.value = student.teacher_id || "";
    teacherSelect.disabled = true;

    examDate.value = "";
    examinerSelect.value = "";
    bonusInput.value = "0";
    deductionsInput.value = "0";
    totalWeightedDisplay.textContent = "%";

    const response = await fetch(`get_duaa_exam_data.php?student_id=${studentId}&year=${year}`);
    const data = await response.json();

    const exam = data.exam;

    
    const tableBody = document.getElementById("duaaTableBody");
    tableBody.innerHTML = "";

    if (data.exists && exam && Array.isArray(exam.duas)) {
        // ✅ Prefill fields
        examDate.value = exam.exam_date || "";
        examinerSelect.value = exam.examiner_id || "";
        bonusInput.value = exam.bonus || 0;
        deductionsInput.value = exam.deductions || 0;

        const isArchived = exam.isArchived;

        // Lock form fields
        [examDate, examinerSelect, studentSelect].forEach(el => {
            el.disabled = true;
            el.style.cursor = "not-allowed";
            el.style.backgroundColor = "#f3f3f3";
        });

        bonusInput.disabled = isArchived;
        deductionsInput.disabled = isArchived;
        bonusInput.style.backgroundColor = isArchived ? "#f3f3f3" : "";
        deductionsInput.style.backgroundColor = isArchived ? "#f3f3f3" : "";

            const grouped = {};
exam.duas.forEach(duaa => {
    const grade = duaa.grade || "Unknown Grade";
    if (!grouped[grade]) grouped[grade] = [];
    grouped[grade].push(duaa);
});


Object.keys(grouped)
    .sort((a, b) => {
        const nA = parseInt(a.replace(/\D/g, '')) || 0;
        const nB = parseInt(b.replace(/\D/g, '')) || 0;
        return nA - nB;
    })
    .forEach(grade => {
        const headingRow = document.createElement("tr");
        headingRow.innerHTML = `
            <td colspan="7" style="background:#d0e7de; font-weight:bold; font-size: 14px; padding: 8px;">
                ${grade}
            </td>`;
        tableBody.appendChild(headingRow);

        grouped[grade].forEach(duaa => {
            const arabic = parseInt(duaa.arabic_max) || 0;
            const trans = parseInt(duaa.translation_max) || 0;
            const aCorrect = parseInt(duaa.arabic_correct) || 0;
            const tCorrect = parseInt(duaa.translation_correct) || 0;
            const notReached = duaa.not_reached == 1;

            const row = document.createElement("tr");
            row.innerHTML = `
                <td data-id="${duaa.duaa_id}" data-arabic="${arabic}" data-translation="${trans}" data-title="${duaa.duaa_title}">
                    ${duaa.duaa_title}
                    <div style="font-size: 11px; color: #777; margin-top: 3px;">
                        Arabic: ${arabic} | English: ${trans}
                    </div>
                </td>
                <td><input type="number" value="${aCorrect}" max="${arabic}"></td>
                <td><input type="number" value="${tCorrect}" max="${trans}"></td>
                <td class="weighted-mark">%</td>
                <td><input type="checkbox" class="skip-arabic-checkbox" ${duaa.skip_arabic ? "checked" : ""}></td>
                <td><input type="checkbox" class="skip-english-checkbox" ${duaa.skip_translation ? "checked" : ""}></td>
                <td><input type="checkbox" class="not-reached-checkbox" ${notReached ? "checked" : ""}></td>
            `;


                    const arabicInput = row.children[1].querySelector("input");
                    const englishInput = row.children[2].querySelector("input");
                    const skipArabic = row.querySelector(".skip-arabic-checkbox");
                    const skipEnglish = row.querySelector(".skip-english-checkbox");
                    const notReachedCheckbox = row.querySelector(".not-reached-checkbox");

                    if (duaa.skip_arabic) arabicInput.disabled = true;
                    if (duaa.skip_translation) englishInput.disabled = true;

                    if (notReached) {
                        [arabicInput, englishInput, skipArabic, skipEnglish].forEach(el => el.disabled = true);
                        row.style.backgroundColor = "#f0f0f0";
                        row.style.color = "#999";
                    }

                    skipArabic.addEventListener("change", () => {
                        arabicInput.disabled = skipArabic.checked;
                        arabicInput.style.backgroundColor = skipArabic.checked ? "#f3f3f3" : "";
                        recalculateTotal();
                    });

                    skipEnglish.addEventListener("change", () => {
                        englishInput.disabled = skipEnglish.checked;
                        englishInput.style.backgroundColor = skipEnglish.checked ? "#f3f3f3" : "";
                        recalculateTotal();
                    });

                    notReachedCheckbox.addEventListener("change", () => {
                        const disabled = notReachedCheckbox.checked;
                        [arabicInput, englishInput, skipArabic, skipEnglish].forEach(el => el.disabled = disabled);
                        row.classList.toggle("disabled-row", disabled);
                        row.style.backgroundColor = disabled ? "#f0f0f0" : "";
                        row.style.color = disabled ? "#999" : "";
                        recalculateTotal();
                    });

                    [arabicInput, englishInput].forEach(inp => inp.addEventListener("input", recalculateTotal));
                    tableBody.appendChild(row);
                });
            });

        recalculateTotal();

                if (submitBtn) submitBtn.style.display = "none";
                if (updateBtn) updateBtn.style.display = "inline-block";
                if (newExamBtn) newExamBtn.style.display = "inline-block";
                isUpdate = true;

        

    } else {
        // ✅ New exam mode
        [examDate, examinerSelect].forEach(el => {
            el.disabled = false;
            el.style.cursor = "";
            el.style.backgroundColor = "";
        });

        bonusInput.value = "0";
        deductionsInput.value = "0";
        bonusInput.disabled = false;
        deductionsInput.disabled = false;

        submitBtn.style.display = "inline-block";
        updateBtn.style.display = "none";
        newExamBtn.style.display = "none";
        isUpdate = false;

        loadDuaTable(() => {
            if (student.last_memorized_dua_id) {
                autoMarkNotReached(student.last_memorized_dua_id);
            }
            recalculateTotal();
        });
    }
});


function autoMarkNotReached(lastMemorizedDuaId) {
    document.querySelectorAll("#duaaTableBody tr").forEach(row => {
        const td = row.querySelector("td");
        const duaId = parseInt(td?.dataset.id || 0);
        if (duaId > lastMemorizedDuaId) {
            const notReached = row.querySelector(".not-reached-checkbox");
            const arabicInput = row.children[1].querySelector("input");
            const englishInput = row.children[2].querySelector("input");
            const skipArabic = row.querySelector(".skip-arabic-checkbox");
            const skipEnglish = row.querySelector(".skip-english-checkbox");

            if (notReached) {
                notReached.checked = true;
                [arabicInput, englishInput, skipArabic, skipEnglish].forEach(el => el.disabled = true);
                row.style.backgroundColor = "#f0f0f0";
                row.style.color = "#999";
                recalculateTotal();
            }
        }
    });
}


    
    function calculateScore(duaa, grade) {
    const aMax = parseInt(duaa.arabic_marks) || 0;
    const tMax = parseInt(duaa.translation_marks) || 0;
    const aCorrect = parseInt(duaa.arabic_correct) || 0;
    const tCorrect = parseInt(duaa.translation_correct) || 0;

    if (aMax === 0) return 0;

    if (["Kindergarten", "Grade 1", "Grade 2"].includes(grade)) {
        return (aCorrect / aMax) * 100;
    } else {
        let score = (aCorrect / aMax) * 85;
        if (tMax > 0) score += (tCorrect / tMax) * 15;
        return score;
    }
}

function recalculateTotal() {
    const rows = document.querySelectorAll("#duaaTableBody tr");
    let totalScore = 0;
    let countIncluded = 0;
    const grade = document.getElementById("grade").value;

    rows.forEach(row => {
        const td = row.querySelector("td");
        if (!td || !td.dataset?.arabic || !td.dataset?.translation) return;

        const notReached = row.querySelector(".not-reached-checkbox")?.checked;
        const skipArabic = row.querySelector(".skip-arabic-checkbox")?.checked;
        const skipEnglish = row.querySelector(".skip-english-checkbox")?.checked;

        const arabicMax = parseInt(td.dataset.arabic) || 0;
        const translationMax = parseInt(td.dataset.translation) || 0;

        const arabicInput = row.children[1]?.querySelector("input");
        const translationInput = row.children[2]?.querySelector("input");

        const arabic = skipArabic ? 0 : (parseInt(arabicInput?.value) || 0);
        const translation = skipEnglish ? 0 : (parseInt(translationInput?.value) || 0);

        if (!notReached) {
            const score = calculateScore({
                arabic_correct: arabic,
                arabic_marks: arabicMax,
                translation_correct: translation,
                translation_marks: translationMax
            }, grade);

            row.querySelector(".weighted-mark").textContent = score.toFixed(2) + "%";
            totalScore += score;
            countIncluded++;
        } else {
            row.querySelector(".weighted-mark").textContent = "N/A";
        }
    });

    // Base score average
    const baseScore = countIncluded ? (totalScore / countIncluded) : 0;

    // Bonus/deductions live inputs
    const bonus = parseFloat(document.getElementById("bonus")?.value) || 0;
    const deductions = parseFloat(document.getElementById("deductions")?.value) || 0;

    // Adjusted score
    let finalScore = baseScore + bonus - deductions;
    finalScore = Math.max(0, Math.min(100, finalScore)); // clamp to 0–100

    const display = document.getElementById("totalWeighted");
    display.textContent = finalScore.toFixed(2) + "%";
    display.dataset.base = baseScore.toFixed(2);
}

document.getElementById("bonus").addEventListener("input", recalculateTotal);
document.getElementById("deductions").addEventListener("input", recalculateTotal);

    
  function loadDuaTable(callback) {
    fetch("fetch_duas.php")
        .then(res => res.json())
        .then(data => {
            const tableBody = document.getElementById("duaaTableBody");
            tableBody.innerHTML = "";

            const grouped = data.duasByGrade;

            Object.keys(grouped)
                .sort((a, b) => {
                    const numA = parseInt(a.replace(/\D/g, '')) || 0;
                    const numB = parseInt(b.replace(/\D/g, '')) || 0;
                    return numA - numB;
                })
                .forEach(grade => {
                    // Grade header row
                    const headingRow = document.createElement("tr");
                    headingRow.innerHTML = `<td colspan="7" style="background:#d0e7de; font-weight:bold; font-size: 14px; padding: 8px;">${grade}</td>`;
                    tableBody.appendChild(headingRow);

                    // Duaa rows
                    grouped[grade].forEach(duaa => {
                        const arabic = parseInt(duaa.arabic_marks) || 0;
                        const translation = parseInt(duaa.translation_marks) || 0;
                        const title = duaa.dua_name;

                        const row = document.createElement("tr");
                        row.innerHTML = `
                            <td data-id="${duaa.id}" data-title="${title}" data-arabic="${arabic}" data-translation="${translation}" style="font-size: 14px;">
                                ${title}
                                <div style="font-size: 11px; color: #777; margin-top: 3px;">
                                    Arabic Marks: ${arabic} | English Marks: ${translation}
                                </div>
                            </td>
                            <td><input type="number" min="0" max="${arabic}" placeholder="0 / ${arabic}" style="font-size: 14px;"></td>
                            <td><input type="number" min="0" max="${translation}" placeholder="0 / ${translation}" style="font-size: 14px;"></td>
                            <td class="weighted-mark" style="font-size: 14px;">%</td>
                            <td><input type="checkbox" class="skip-arabic-checkbox"></td>
                            <td><input type="checkbox" class="skip-english-checkbox"></td>
                            <td><input type="checkbox" class="not-reached-checkbox"></td>
                        `;

                        const arabicInput = row.children[1].querySelector("input");
                        const englishInput = row.children[2].querySelector("input");
                        const skipArabic = row.querySelector(".skip-arabic-checkbox");
                        const skipEnglish = row.querySelector(".skip-english-checkbox");
                        const notReached = row.querySelector(".not-reached-checkbox");

                        // ✅ Not Reached toggle
                        notReached.addEventListener("change", () => {
                            const disabled = notReached.checked;
                            [arabicInput, englishInput, skipArabic, skipEnglish].forEach(el => {
                                el.disabled = disabled;
                                if (el.type === "number") {
                                    el.value = "";
                                    el.style.backgroundColor = disabled ? "#f3f3f3" : "";
                                }
                            });
                            row.classList.toggle("disabled-row", disabled);
                            row.style.backgroundColor = disabled ? "#f0f0f0" : "";
                            row.style.color = disabled ? "#999" : "";
                            recalculateTotal();
                        });

                        // ✅ Skip Arabic checkbox
                        skipArabic.addEventListener("change", () => {
                            arabicInput.disabled = skipArabic.checked;
                            arabicInput.style.backgroundColor = skipArabic.checked ? "#f3f3f3" : "";
                            recalculateTotal();
                        });

                        // ✅ Skip English checkbox
                        skipEnglish.addEventListener("change", () => {
                            englishInput.disabled = skipEnglish.checked;
                            englishInput.style.backgroundColor = skipEnglish.checked ? "#f3f3f3" : "";
                            recalculateTotal();
                        });

                        [arabicInput, englishInput].forEach(input => {
                            input.addEventListener("input", recalculateTotal);
                        });

                        tableBody.appendChild(row);
                    });
                });

            if (typeof callback === "function") callback();
        })
        .catch(err => {
            console.error("Dua fetch error:", err);
            alert("❌ Failed to load Duas.");
        });
}



            function attachSubmitHandler() {
    const submitBtn = document.getElementById("submitBtn");
    const updateBtn = document.getElementById("updateBtn");
    const newExamBtn = document.getElementById("newExamBtn");

    const handleSubmit = (mode) => {
        const studentId = document.getElementById("studentName").value;
        const teacherId = document.getElementById("teacher").value;
        const examinerId = document.getElementById("examiner").value;
        const grade = document.getElementById("grade").value;
        const examDate = document.getElementById("examDate").value;

        if (!studentId || !teacherId || !examinerId || !grade || !examDate) {
            alert("❗ Please fill all required fields.");
            return;
        }

        const bonus = parseFloat(document.getElementById("bonus")?.value) || 0;
        const deductions = parseFloat(document.getElementById("deductions")?.value) || 0;

        const rows = document.querySelectorAll("#duaaTableBody tr");
        let totalWeighted = 0;
        let countIncluded = 0;
        const duas = [];

        rows.forEach(row => {
            const td = row.querySelector("td");
            if (!td || !td.dataset.id) return;

            const duaaId = parseInt(td.dataset.id);
            const title = td.dataset.title;
            const arabicMax = parseInt(td.dataset.arabic);
            const translationMax = parseInt(td.dataset.translation);
            const arabicInput = row.children[1].querySelector("input");
            const translationInput = row.children[2].querySelector("input");
            const notReached = row.querySelector(".not-reached-checkbox")?.checked;
            const skipArabic = row.querySelector(".skip-arabic-checkbox")?.checked;
            const skipEnglish = row.querySelector(".skip-english-checkbox")?.checked;

            let arabic = 0, translation = 0;

            if (!notReached) {
                arabic = parseInt(arabicInput?.value) || 0;
                translation = parseInt(translationInput?.value) || 0;
                const score = calculateScore({
                    arabic_correct: arabic,
                    arabic_marks: arabicMax,
                    translation_correct: translation,
                    translation_marks: translationMax
                }, grade);
                row.querySelector(".weighted-mark").textContent = score.toFixed(2) + "%";
                totalWeighted += score;
                countIncluded++;
            } else {
                row.querySelector(".weighted-mark").textContent = "N/A";
            }

            duas.push({
                duaa_id: duaaId,
                title: title,
                arabic_max: arabicMax,
                translation_max: translationMax,
                arabic_correct: arabic,
                translation_correct: translation,
                not_reached: notReached ? 1 : 0,
                skip_arabic: skipArabic ? 1 : 0,
                skip_translation: skipEnglish ? 1 : 0
            });
        });

        const baseScore = countIncluded ? (totalWeighted / countIncluded) : 0;
        const adjustedScore = Math.max(0, Math.min(100, baseScore + bonus - deductions));
        document.getElementById("totalWeighted").textContent = adjustedScore.toFixed(2) + "%";

        const postData = {
            student_id: parseInt(studentId),
            teacher_id: parseInt(teacherId),
            examiner_id: parseInt(examinerId),
            grade: grade,
            exam_date: examDate,
            final_score: adjustedScore.toFixed(2),
            bonus: bonus,
            deductions: deductions,
            duas: duas
        };

        const endpoint = mode === 'update' ? "update_duaa_exam.php" : "submit_duaa_exam.php";

        fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(postData)
        })
        .then(res => res.json())
        .then(response => {
            if (response.success) {
                alert("✅ " + (mode === 'update' ? "Marks updated" : "Exam submitted") + " successfully!\nFinal Score: " + adjustedScore.toFixed(2) + "%");
            } else {
                alert("❌ Submission failed: " + (response.error || "Unknown error"));
            }
        })
        .catch(err => {
            console.error("Submit error:", err);
            alert("❌ Could not submit exam.");
        });
    };

    if (submitBtn) submitBtn.addEventListener("click", () => handleSubmit("submit"));
    if (updateBtn) updateBtn.addEventListener("click", () => handleSubmit("update"));
    if (newExamBtn) newExamBtn.addEventListener("click", () => {
        const examDate = document.getElementById("examDate");
        const examinerSelect = document.getElementById("examiner");
        const studentSelect = document.getElementById("studentName");
        const bonusInput = document.getElementById("bonus");
        const deductionsInput = document.getElementById("deductions");
        const totalDisplay = document.getElementById("totalWeighted");

        examDate.disabled = false;
        examinerSelect.disabled = false;
        studentSelect.disabled = false;

        examDate.value = "";
        examinerSelect.value = "";
        bonusInput.value = "";
        deductionsInput.value = "";
        totalDisplay.textContent = "%";

        [examDate, examinerSelect, studentSelect].forEach(el => {
            el.style.cursor = "";
            el.style.backgroundColor = "";
        });

        const tableBody = document.getElementById("duaaTableBody");
        tableBody.querySelectorAll("tr").forEach(row => {
            const td = row.querySelector("td");
            if (!td?.dataset?.id) return;

            const arabicInput = row.children[1]?.querySelector("input");
            const englishInput = row.children[2]?.querySelector("input");
            const skipArabic = row.querySelector(".skip-arabic-checkbox");
            const skipEnglish = row.querySelector(".skip-english-checkbox");
            const notReached = row.querySelector(".not-reached-checkbox");

            arabicInput.value = "";
            englishInput.value = "";
            skipArabic.checked = false;
            skipEnglish.checked = false;
            notReached.checked = false;

            [arabicInput, englishInput, skipArabic, skipEnglish].forEach(el => {
                el.disabled = false;
                el.style.backgroundColor = "";
            });

            row.classList.remove("disabled-row");
            row.style.backgroundColor = "";
            row.style.color = "";
            row.querySelector(".weighted-mark").textContent = "%";
        });

        if (submitBtn) submitBtn.style.display = "inline-block";
        if (updateBtn) updateBtn.style.display = "none";
        if (newExamBtn) newExamBtn.style.display = "none";
        isUpdate = false;

        recalculateTotal();
    });
}


    </script>
    
    

</body>
</html>
